'
'                 Mystic Realm
'                 by John Lince
'                 Copyright 1990 Antic Publishing Inc.
'
Res%=Xbios(4)
If Res%=1
  A%=Xbios(3)
  B%=Xbios(2)
  C%=Xbios(5,L:A%,L:B%,0)
Else
  If Res%>1
    Alert 3,"|  MYSTIC REALM  | | Can't operate in high rez. ",1," darn ",A
    End
  Endif
Endif
'
Z$=Mki$(0)+Mki$(0)+Mki$(1)           !
For T=1 To 37                        !
  Z$=Z$+Mki$(0)                      ! remove mouse from screen
Next T                               !
Defmouse Z$                          !
Hidem                                !
@Save_pal
'
R=Xbios(35,0,0)                      ! turn keyboard repeat off
Path$=Dir$(0)+"\"
If Not Exist(Path$+"char.dat")
  Alert 3,"The file CHAR.DAT must|be in the same directory|as MYSTIC.PRG.",1,"Abort",D
  @Exit
Endif
If Not Exist(Path$+"info_fil.e")
  Alert 3,"The file INFOFI.LE must|be in the same directory|as MYSTIC.PRG.",1,"Abort",D
  @Exit
Endif
If Not Exist(Path$+"mysticre.alm")
  Alert 3,"The file MYSTICRE.ALM must|be in the same directory|as MYSTIC.PRG.",1,"Abort",D
  @Exit
Endif
'
For T=0 To 15
  Setcolor T,0,0,0                   ! turn screen black
Next T
'
Bload Path$+"char.dat",Xbios(2)
Dim A$(116),Scrn(240),Mon(50),Mons%(240),F(20),D%(250)
Dim Screens%(8800),Mondir%(2000),Mns%(8800),Brd$(440)
'
' ******************************************************
' GET statements disect screen into smaller chuncks
' These chunks are the characters to be used in the game
' ******************************************************
'
Get 0,0,15,3,A$(50)
For T=16 To 304 Step 16
  Get T,0,T+15,15,A$((T/16)+19)
Next T
Get 240,32,271,63,A$(63)
Get 288,32,319,63,A$(64)
Get 240,16,255,31,A$(90)
Get 224,16,239,31,A$(68)
Get 0,48,15,63,A$(91)
Get 124,64,192,71,A$(92)
Get 80,48,95,63,A$(84)
Get 128,48,143,63,A$(85)
Get 288,24,319,31,A$(14)
Get 48,48,63,63,A$(62)
Get 56,64,63,71,A$(75)
Get 48,64,55,71,A$(74)
Get 40,64,47,71,A$(73)
Get 32,64,39,71,A$(72)
Get 160,48,175,63,A$(80)
Get 208,48,223,63,A$(82)
Get 176,48,191,63,A$(81)
Get 191,48,207,63,A$(83)
Get 88,64,95,71,A$(67)
Get 0,64,7,71,A$(65)
Get 8,64,15,71,A$(66)
Get 0,0,7,7,A$(59)
Get 144,32,159,47,A$(71)
Get 144,48,159,63,A$(70)
Get 64,48,79,63,A$(43)
Get 0,0,15,15,A$(48)
Get 96,48,111,63,A$(41)
Get 112,48,127,63,A$(42)
Get 16,48,31,63,A$(44)
Get 64,32,79,47,A$(16)
Get 80,32,95,47,A$(18)
Get 0,0,3,15,A$(49)
Get 96,32,111,47,A$(19)
Get 112,32,127,47,A$(17)
Get 128,32,143,47,A$(60)
Get 32,32,47,47,A$(51)
Get 16,32,31,47,A$(52)
A$(54)=A$(52)
Get 48,32,63,47,A$(53)
Get 16,64,23,71,A$(55)
Get 65,64,71,71,A$(56)
Get 72,64,79,71,A$(57)
Get 80,64,87,71,A$(58)
Get 104,64,111,71,A$(116)
Get 32,48,47,63,A$(61)
For T=0 To (16*12) Step 16
  Get T,16,T+15,31,A$((T/16)+1)
  Get T,88,T+15,103,A$((T/16)+101)
Next T
Get 0,32,15,47,A$(15)
Get 208,32,223,47,A$(79)
Get 176,32,191,47,A$(76)
Get 192,32,207,47,A$(77)
A$(78)=A$(76)
Get 0,72,15,87,A$(93)
Get 16,72,31,87,A$(94)
Get 32,72,47,87,A$(95)
A$(96)=A$(94)
A$(27)=A$(101)
A$(100)=A$(1)
Get 64,72,79,87,A$(86)
Get 80,72,95,87,A$(87)
Get 96,72,111,87,A$(88)
Get 112,72,127,87,A$(89)
Get 48,72,63,87,A$(97)
Get 256,16,271,31,A$(98)
Get 96,64,103,71,A$(47)
Get 272,16,287,31,A$(39)
Get 272,32,287,47,A$(40)
'
' ************************************
' clear screen and load picture screen
' ************************************
'
Cls
Bload Path$+"mysticre.alm",Xbios(2)
'
' turn color on
'
Setcolor 0,0,0,0
Setcolor 1,3,3,3
Setcolor 2,7,3,0
Setcolor 3,7,5,0
Setcolor 4,7,7,0
Setcolor 5,0,4,0
Setcolor 6,0,6,0
Setcolor 7,4,2,0
Setcolor 8,5,3,1
Setcolor 9,3,5,7
Setcolor 10,0,3,7
Setcolor 11,0,0,7
Setcolor 12,5,1,1
Setcolor 13,2,2,2
Setcolor 14,6,0,0
Setcolor 15,6,6,6
Gosub Init
'
'  ***   main loop   ***
'
While Game=0
  Sound 1,0,#0
  Sound 2,0,#0
  Wave 1,8,8,8
  Wave 2,16,16,16
  Close
  Open "I",#1,Path$+"info_fil.e"
  Gosub Get_level
  Gosub O_s
  For T=1 To 240
    Mons%(T)=0
    Scrn(T)=0
  Next T
  For T=1 To 50
    Mon(T)=0
  Next T
  Deftext 10,16,0,4
  Food%=900
  Lev%=1
  Room=1
  Kn=100
  Cash=500
  Clok=100
  Diam=0
  Key=0
  Men%=2
  Gosub Setscrn
  Odiam=Diam
  Okey=Key
  Oclok=Clok
  Ofood=Food%
  Okn=Kn
  Co=0
  '
  While Men%>0
    Gosub Nt
    '
    While Die<>1
      Inc Count%
      If Count%>4
        Count%=0
        Dec Food%
      Endif
      If Pre_fd<>Food%
        Gosub Times
        Pre_fd=Food%
      Endif
      Add Co,0.01
      B$=Inkey$
      If B$<>""
        Gosub Get_chars
      Endif
      If Done=1
        Gosub Get_done
        If Lev%=4 Or Lev%=6 Or Lev%=8 Or Lev%>9
          Gosub Buy
          Gosub Get_level
          Swt=1
        Endif
        Done=0
      Endif
      If Bye<>0
        Gosub Nex_room
        Room=Bye
        Bye=0
        If Swt=1
          Okey=Key
          Ocash=Cash
          Odiam=Diam
          Oclok=Clok
          Swt=0
        Endif
        Gosub Nt
      Endif
      If Clok>0 And Cstart=1
        If Clok Mod 3=0
          Sound 1,2,#300
          Sound 2,0,#0
          Wave 1,1,0,64
        Endif
        Vsync
        Put X,Y,A$(48)
        Sub Clok,0.25
        Color 2
        Line Clok+14,196,Clok+14,197
      Endif
      If Food%=<0
        Die=1
      Endif
      Gosub Jj
      Add Fid%,(Fid%>0)
      If Fire%=1 And Fid%=0
        Gosub Fired
      Endif
      On (Joy%+1) Gosub Nt,Topup,Godwn,Nt,Left,Ul,Dl,Nt,Rig,Ur,Dr,Nt,Nt,Nt,Nt,Nt
      Gosub Sho
      Gosub Monsters
    Wend
    '
    ' ***   if dead   ***
    '
    Put X,Y,A$(68)
    For S=1 To 125
      For T=15 To 1 Step -0.3
        Sound 1,T,#(950+S)
      Next T
    Next S
    Sound 1,0,0
    Put Men%*8+270,192,A$(59)
    Sub Men%,1
    Key=Okey
    Diam=Odiam
    Cash=Ocash
    Clok=Oclok
    Food%=900
    Kn=Okn
    If Kn<25
      Kn=50
    Endif
    If Men%>0
      Gosub Died
    Endif
    Die=0
    Cstart=0
    Zt%=0
    Shoo%=0
  Wend
  '
  '  *** game over ***
  '
  Put X,Y,A$(15)
Wend
'
Procedure Jj                   ! read joystick
  Joy%=Peek(Js%)
  Fire%=0-(Joy%>127)
  Add Joy%,(Joy%>127)*128
Return
'
Procedure Dr                       ! move down and right (diagonal)
  Ok=1
  Cx=4
  Cy=4
  If (X Mod 16)=0
    Gosub Rigcheck
    If Ok=0
      Cx=0
    Endif
  Endif
  If (Y Mod 16)=0
    V=Ok
    Ok=1
    Gosub Chkdwn
    If Ok=0
      Cy=0
    Else
      Ok=V
    Endif
  Endif
  If (X Mod 16)=0 And (Y Mod 16)=0 And Ok=1
    Gosub Dr_diag
    If Ok=0
      Cx=0
      Cy=0
    Endif
  Endif
  If Num%=1 Or Num%>5
    Num%=2
    Cy=0
    Cx=0
  Else
    If Cx=4
      Add X,4
    Endif
    If Cy=4
      Add Y,4
    Endif
  Endif
  If X>304
    X=304
    Cx=0
  Endif
  If Y>176
    Y=176
    Cy=0
  Endif
  Inc Num%
  If Num%=6
    Num%=2
  Endif
  If Cx<>0 Or Cy<>0
    Vsync
    Put X-Cx,Y-Cy,A$(50)
  Endif
  Vsync
  Put X,Y,A$(Num%)
Return
'
Procedure Dl                     ! move down and left (diagonal)
  Er=0
  Ok=1
  Cx=4
  Cy=4
  If (X Mod 16)=0
    Gosub Checklef
    If Ok=0
      Cx=0
    Endif
  Endif
  If (Y Mod 16)=0
    V=Ok
    Ok=1
    Gosub Chkdwn
    If Ok=0
      Cy=0
    Else
      Ok=V
    Endif
  Endif
  If (X Mod 16)=0 And (Y Mod 16)=0 And Ok=1
    Gosub Dl_diag
    If Ok=0
      Cx=0
      Cy=0
    Endif
  Endif
  If Num%<6 Or Num%>9
    Num%=6
    Cx=0
    Cy=0
  Else
    If Cx=4
      Sub X,4
    Endif
    If Cy=4
      Add Y,4
    Endif
  Endif
  If X<0
    X=0
    Cx=0
  Endif
  If Y>176
    Y=176
    Cy=0
  Endif
  Inc Num%
  If Num%=10
    Num%=6
  Endif
  If Cx<>0 Or Cy<>0
    Vsync
    Put X+Cx,Y-Cy,A$(50)
  Endif
  Vsync
  Put X,Y,A$(Num%)
Return
'
Procedure Ul                      ! move up and left  (diagonal)
  Ok=1
  Cy=4
  Cx=4
  If (X Mod 16)=0
    Gosub Checklef
    If Ok=0
      Cx=0
    Endif
  Endif
  If (Y Mod 16)=0
    V=Ok
    Ok=1
    Gosub Upchk
    If Ok=0
      Cy=0
    Else
      Ok=V
    Endif
  Endif
  If (Y Mod 16)=0 And (X Mod 16)=0 And Ok=1
    Gosub Ul_diag
    If Ok=0
      Cx=0
      Cy=0
    Endif
  Endif
  If Num%<6 Or Num%>9
    Num%=5
    Cx=0
    Cy=0
  Else
    If Cx=4
      Sub X,4
    Endif
    If Cy=4
      Sub Y,4
    Endif
  Endif
  If X<0
    X=0
    Cx=0
  Endif
  If Y<16
    Cy=0
    Y=16
  Endif
  Inc Num%
  If Num%=10
    Num%=6
  Endif
  If Cx<>0 Or Cy<>0
    Vsync
    Put X+Cx,Y+12+Cy,A$(50)
  Endif
  Vsync
  Put X,Y,A$(Num%)
Return
'
Procedure Ur                       ! move up and right (diagonal)
  Cx=4
  Cy=4
  Ok=1
  If (X Mod 16)=0
    Gosub Rigcheck
    If Ok=0
      Cx=0
    Endif
  Endif
  If Y Mod 16=0
    V=Ok
    Ok=1
    Gosub Upchk
    If Ok=0
      Cy=0
    Else
      Ok=V
    Endif
  Endif
  If (Y Mod 16)=0 And (X Mod 16)=0 And Ok=1
    Gosub Ru_diag
    If Ok=0
      Cx=0
      Cy=0
    Endif
  Endif
  If Num%>5 Or Num%=1
    Num%=1
    Cx=0
    Cy=0
  Else
    If Cx=4
      Add X,4
    Endif
    If Cy=4
      Sub Y,4
    Endif
  Endif
  Inc Num%
  If Num%=6
    Num%=2
  Endif
  If X>304
    X=304
    Cx=0
  Endif
  If Y<16
    Y=16
    Cy=0
  Endif
  If Cx<>0 Or Cy<>0
    Vsync
    Put X-Cx,Y+12+Cy,A$(50)
  Endif
  Vsync
  Put X,Y,A$(Num%)
Return
'
Procedure Rig                    ! move right
  If (X Mod 16)=0
    Gosub Rigcheck
  Else
    Ok=1
  Endif
  If Num%=1
    If Ok=1
      Sub X,4
    Endif
    Num%=2
  Endif
  If Num%>5
    Num%=0
    If Ok=1
      Sub X,4
    Endif
  Endif
  Inc Num%
  If Num%=6
    Num%=2
  Endif
  If Ok=1
    Add X,4
  Endif
  If X>=308
    X=304
  Endif
  Vsync
  Put X,Y,A$(Num%)
Return
'
Procedure Left                    ! move left
  If (X Mod 16)=0
    Gosub Checklef
  Else
    Ok=1
  Endif
  If Num%=1
    Num%=6
    If Ok=1
      Add X,4
    Endif
  Endif
  If Num%<6 Or Num%>9
    Num%=1
  Else
    If Ok=1
      Sub X,4
    Endif
    If X<0
      X=0
    Endif
    Inc Num%
    If Num%=10
      Num%=6
    Endif
  Endif
  Vsync
  Put X,Y,A$(Num%)
  Ok=0
Return
'
Procedure Topup                  ! move up
  If (Y Mod 16)=0
    Gosub Upchk
  Else
    Ok=1
  Endif
  If Num%=10 Or Num%=11
    Inc Num%
    If Num%=12
      Num%=10
    Endif
    Er%=1
    If Ok=1
      Sub Y,4
    Endif
    If Y<16
      Er%=0
      Y=16
    Endif
  Else
    If Num%=1
      Num%=10
    Else
      Num%=1
    Endif
  Endif
  Vsync
  Put X,Y,A$(Num%)
  If Er%=1 And Ok=1
    Put X,Y+16,A$(50)
  Endif
  Er%=0
Return
'
Procedure Godwn                    ! move down
  If (Y Mod 16)=0
    Gosub Chkdwn
  Else
    Ok=1
  Endif
  If Num%=12 Or Num%=13
    Inc Num%
    Er%=1
    If Num%=14
      Num%=12
    Endif
    If Y<176
      If Ok=1
        Add Y,4
      Endif
    Else
      Er%=0
    Endif
  Else
    Num%=1-(Num%=1)*11
  Endif
  Vsync
  Put X,Y,A$(Num%)
  If Er%=1 And Ok=1
    Put X,Y-4,A$(50)
  Endif
  Er%=0
Return
'
Procedure Nt                     ! not moving at all
  Vsync
  If X<0
    X=0
  Endif
  Put X,Y,A$(1)
  Num%=1
  For T=1 To 15
  Next T
Return
'
Procedure Setscrn                ! draw room on screen
  Cls
  For T%=0 To 19
    Put T%*16,184,A$(48)
    Put T%*16,8,A$(48)
  Next T%
  If Clok>0
    Color 3
    Line 14,196,Clok+13,196
    Line 14,197,Clok+13,197
  Endif
  Put 1,192,A$(47)
  Text 5,5,"POWER"
  Text 125,5,"KNIVES"
  Text 176,5,Kn
  Scrn(0)=2
  For T=1 To 11
    For S=0 To 19
      It=Asc(Mid$(Brd$(T+(Room-1)*11),S+1,1))-63
      Gosub Show
      Scrn(S+1+((T-1)*20))=It-1
    Next S
  Next T
  For T%=1 To Men%
    Put T%*8+270,192,A$(65)
  Next T%
  D%(Room*5)=1
  For T=1 To 4
    If D%(T+(Room-1)*5)<>0
      Put 260+T*8,8,A$(76-T)
    Else
      Put 260+T*8,8,A$(59)
    Endif
  Next T
  If Key>0
    For T%=1 To Key
      Put 120+T%*8,8,A$(66)
    Next T%
  Endif
  If Diam>0
    For T%=1 To Diam
      Put 10+T%*8,8,A$(67)
    Next T%
  Endif
  Text 250,5,"LEVEL"
  Text 295,5,Lev%
Return
'
Procedure Rigcheck              ! what is to the right?
  Z%=Y Div 16
  Z2%=(Y Mod 16)
  S%=(X/16+(Z%-1)*20)+2
  Ok=1
  If Scrn(S%)=31
    Done=1
  Else
    If Z2%<>0
      If Scrn(S%+20)=31
        Done=1
      Endif
    Endif
  Endif
  If Scrn(S%)=29 And Key>0
    Put 120+Key*8,8,A$(59)
    Dec Key
    Scrn(S%)=0
    Vsync
    Put X+16,Z%*16,A$(48)
    Sound 1,12,#700
    Sound 2,12,#70000
    Wave 7,7,0,4096
  Endif
  If X=304 And D%(3+(Room-1)*5)<>0
    Bye=3
  Endif
  E%=Scrn(S%)
  If E%=1 Or E%=2 Or E%=3 Or E%=4 Or E%=28 Or E%=29 Or E%>31
    Ok=0
    If E%=33 And Diam>0
      Sound 2,2,#7000
      Sound 1,2,#8000
      Put 10+Diam*8,8,A$(59)
      Dec Diam
      Put X+16,Z%*16,A$(81)
      If Scrn(S%-40)=44
        Scrn(S%-20)=0
        For E=1 To 15
          Put X+16,Z%*16-16,A$(84)
          Sound 1,14,#900
          Put X+16,Z%*16-16,A$(85)
          Sound 1,14,#7000
        Next E
        Put X+16,Z%*16-16,A$(48)
      Endif
      Scrn(S%)=43
      Wave 15,7,9,4096
    Else
      If E%=34 And Diam>0
        Sound 2,2,#7000
        Sound 1,2,#8000
        Put 10+Diam*8,8,A$(59)
        Dec Diam
        Put X+16,Z%*16,A$(83)
        If Scrn(S%+40)=43
          Scrn(S%+20)=0
          For E=1 To 15
            Put X+16,Z%*16+16,A$(84)
            Sound 1,14,#900
            Put X+16,Z%*16+16,A$(85)
            Sound 1,14,#7000
          Next E
          Put X+16,Z%*16+16,A$(48)
        Endif
        Scrn(S%)=44
        Wave 15,7,9,4096
      Endif
    Endif
  Endif
  If Z2%<>0
    E%=Scrn(S%+20)
    If E%=1 Or E%=2 Or E%=3 Or E%=4 Or E%=28 Or E%=29 Or E%>31
      Ok=0
    Endif
  Endif
  If Ok=1
    If Scrn(S%)<26 And Scrn(S%)>4
      Sound 1,12,#700
      Sound 2,12,#70000
      Wave 15,7,9,2048
      Put X+16,Z%*16,A$(48)
      Obj=Scrn(S%)
      Gosub Got_obj
      Scrn(S%)=0
    Endif
    If Z2%<>0
      If Scrn(S%+20)>4 And Scrn(S%+20)<26
        Sound 1,12,#700
        Sound 2,12,#70000
        Wave 15,7,9,2048
        Put X+16,Z%*16+16,A$(48)
        Obj=Scrn(S%+20)
        Gosub Got_obj
        Scrn(S%+20)=0
      Endif
    Endif
  Endif
Return
'
Procedure Ul_diag                ! what up and to the left (diagonal)?
  Z%=(X/16)+(Y/16)*20-40
  If Z%>0
    Z2%=Scrn(Z%)
    If Z2%>4 And Z2%<26
      Obj=Z2%
      Gosub Got_obj
      Sound 1,12,#700
      Sound 2,12,#70000
      Wave 15,7,9,2048
      Scrn(Z%)=0
      Put X-16,Y-16,A$(48)
    Else
      If (Z2%>0 And Z2%<5) Or Z2%=28 Or Z2%=29 Or (Z2%>30 And Z2%<50)
        Ok=0
      Endif
    Endif
  Else
    Ok=0
  Endif
Return
'
Procedure Dl_diag                ! what is down and to the left (diagonal)?
  Z%=(X/16)+(Y/16)*20
  Z2%=Scrn(Z%)
  If Z2%>4 And Z2%<26
    Obj=Z2%
    Gosub Got_obj
    Scrn(Z%)=0
    Put X-16,Y+16,A$(48)
    Sound 1,12,#700
    Sound 2,12,#70000
    Wave 15,7,9,2048
  Else
    If (Z2%>0 And Z2%<5) Or Z2%=28 Or Z2%=29 Or (Z2%>30 And Z2%<50)
      Ok=0
    Endif
  Endif
Return
'
Procedure Dr_diag                ! what is down and to the right (diagonal)?
  Z%=(X/16)+(Y/16)*20+2
  If Z%<220
    Z2%=Scrn(Z%)
    If Z2%>4 And Z2%<26
      Obj=Z2%
      Gosub Got_obj
      Sound 1,12,#700
      Sound 2,12,#70000
      Wave 15,7,9,2048
      Scrn(Z%)=0
      Put X+16,Y+16,A$(48)
    Else
      If (Z2%>0 And Z2%<5) Or Z2%=28 Or Z2%=29 Or (Z2%>30 And Z2%<50)
        Ok=0
      Endif
    Endif
  Else
    Ok=0
  Endif
Return
'
Procedure Ru_diag                ! what is up and to the right (diagonal)?
  Z%=(X/16)+(Y/16)*20-38
  If Z%>0
    Z2%=Scrn(Z%)
    If Z2%>4 And Z2%<26
      Obj=Z2%
      Gosub Got_obj
      Sound 1,12,#700
      Sound 2,12,#70000
      Wave 15,7,9,2048
      Scrn(Z%)=0
      Put X+16,Y-16,A$(48)
    Else
      If (Z2%>0 And Z2%<5) Or Z2%=28 Or Z2%=29 Or (Z2%>30 And Z2%<50)
        Ok=0
      Endif
    Endif
  Else
    Ok=0
  Endif
Return
'
Procedure Checklef               ! what is to the left?
  Z%=(Y Div 16)
  Z2%=(Y Mod 16)
  S%=(X Div 16+(Z%-1)*20)
  Ok=1
  If Scrn(S%)=29
    If Key>0
      Put 120+8*Key,8,A$(59)
      Dec Key
      Put X-16,Z%*16,A$(48)
      Sound 1,15,#70000
      Sound 2,14,#7000
      Wave 7,7,9,4096
      Scrn(S%)=0
    Endif
  Endif
  If X=0 And D%((Room-1)*5+4)<>0
    Bye=4
  Endif
  If (Scrn(S%)>=1 And Scrn(S%)<=4) Or Scrn(S%)=28 Or Scrn(S%)=29 Or Scrn(S%)>32
    Ok=0
    If Scrn(S%)=33 And Diam>0
      Sound 2,2,#7000
      Sound 1,2,#8000
      Put 10+Diam*8,8,A$(59)
      Dec Diam
      Put X-16,Z%*16,A$(81)
      Scrn(S%)=43
      If Scrn(S%-40)=44
        Scrn(S%-20)=0
        For E=1 To 15
          Put X-16,Z%*16-16,A$(84)
          Sound 1,14,#900
          Put X-16,Z%*16-16,A$(85)
          Sound 1,14,#7000
        Next E
        Put X-16,Z%*16-16,A$(48)
      Endif
      Wave 15,7,9,4096
    Else
      If Scrn(S%)=34 And Diam>0
        Sound 2,2,#7000
        Sound 1,2,#8000
        Put 10+Diam*8,8,A$(59)
        Dec Diam
        Put X-16,Z%*16,A$(83)
        Scrn(S%)=44
        If Scrn(S%+40)=43
          Scrn(S%+20)=0
          For E=1 To 15
            Put X-16,Z%*16+16,A$(84)
            Sound 1,14,#900
            Put X-16,Z%*16+16,A$(85)
            Sound 1,15,#7000
          Next E
          Put X-16,Z%*16+16,A$(48)
        Endif
        Wave 15,7,9,4096
      Endif
    Endif
  Endif
  If Z2%<>0
    If (Scrn(S%+20)>=1 And Scrn(S%+20)<=4) Or Scrn(S%+20)=28 Or Scrn(S%)=29 Or Scrn(S%+20)>32
      Ok=0
    Else
      If Scrn(S%+20)=31
        Done=1
      Endif
    Endif
  Endif
  If Ok=1
    If Scrn(S%)>4 And Scrn(S%)<26
      Sound 1,12,#700
      Sound 2,12,#70000
      Wave 15,7,9,2048
      Put X-16,Z%*16,A$(48)
      Obj=Scrn(S%)
      Gosub Got_obj
      Scrn(S%)=0
    Else
      If Scrn(S%)=31
        Done=1
      Endif
    Endif
    If Z2%<>0
      If Scrn(S%+20)>4 And Scrn(S%+20)<26
        Sound 1,12,#700
        Sound 2,12,#70000
        Wave 15,7,9,2048
        Put X-16,Z%*16+16,A$(48)
        Obj=Scrn(S%+20)
        Gosub Got_obj
        Scrn(S%+20)=0
      Else
        If Scrn(S%+20)=31
          Done=1
        Endif
      Endif
    Endif
  Endif
Return
'
Procedure Show                  ! actual drawing of items on screen
  Q%=It
  Dec Q%
  Ss=S*16
  Tt=T*16
  If Q%=0
    Put Ss,Tt,A$(48)
  Else
    If Q%>0 And Q%<5
      On Q% Gosub 1,2,3,4
    Else
      If Q%>4 And Q%<26
        Put Ss,Tt,A$(Q%+15)
      Else
        If Q%=27 Or Q%=26 Or Q%=32 Or Q%=38 Or Q%=39
          Put Ss,Tt,A$(16-(Q%=27)*35-(Q%=32)*60-(Q%=38)*70-(Q%=39)*77)
          For P%=1 To 10
            If Mon(P%*5-1)=0
              Mon(P%*5-4)=Ss
              Mon(P%*5-3)=Tt
              Mon(P%*5-2)=1
              Mon(P%*5-1)=5
              Mon(P%*5)=18+(Q%=27)*2-(Q%=32)*14-(Q%=38)*20-(Q%=39)*21
              Mons%(S+1+(T-1)*20)=1
              P%=11
            Endif
          Next P%
          It=1
        Else
          If Q%=30
            X=Ss
            Y=Tt
            Put X,Y,A$(1)
            It=1
          Else
            Pu=(0-(Q%=31)*62-(Q%=29)*70-(Q%=28)*61-(Q%=33)*80-(Q%=34)*82-(Q%=35)*90-(Q%=36)*91-(Q%=40)*97-(Q%=41)*98-(Q%=43)*81-(Q%=44)*83)
            Put Ss,Tt,A$(Pu)
          Endif
        Endif
      Endif
    Endif
  Endif
Return
'
Procedure 1
  Put Ss,Tt,A$(43)
Return
Procedure 2
  Put Ss,Tt,A$(41)
Return
Procedure 3
  Put Ss,Tt,A$(42)
Return
Procedure 4
  Put Ss,Tt,A$(44)
Return
'
Procedure Chkdwn                 ! what is below you?
  Local Z%,Z2%,S%
  Z%=(X Div 16)
  Z2%=(X Mod 16)
  Ok=1
  S%=Z%+(Y Div 16)*20+1
  If Scrn(S%)=29 And Key>0
    Put 120+8*Key,8,A$(59)
    Dec Key
    Sound 1,15,#7000
    Sound 2,14,#70000
    Wave 7,7,9,4096
    Scrn(S%)=0
    Vsync
    Put Z%*16,Y+16,A$(48)
  Endif
  If Y=176 And D%((Room-1)*5+2)<>0
    Bye=2
  Endif
  If (Scrn(S%)>=1 And Scrn(S%)<=4) Or Scrn(S%)=28 Or Scrn(S%)=29 Or Scrn(S%)>32
    Ok=0
  Endif
  If Z2%<>0
    If (Scrn(S%+1)>=1 And Scrn(S%+1)<=4) Or Scrn(S%+1)=28 Or Scrn(S%+1)=29 Or Scrn(S%+1)>32
      Ok=0
    Endif
  Endif
  If Ok=1
    If Scrn(S%)>4 And Scrn(S%)<26
      Sound 1,12,#700
      Sound 2,12,#70000
      Wave 15,7,9,2048
      Obj=Scrn(S%)
      Gosub Got_obj
      Put Z%*16,Y+16,A$(48)
      Scrn(S%)=0
    Else
      If Scrn(S%)=31
        Done=1
      Endif
    Endif
    If Z2%<>0
      If Scrn(S%+1)>4 And Scrn(S%+1)<26
        Put Z%*16+16,Y+16,A$(48)
        Sound 1,12,#700
        Sound 2,12,#70000
        Wave 15,7,9,2048
        Obj=Scrn(S%+1)
        Gosub Got_obj
        Scrn(S%+1)=0
      Else
        If Scrn(S%+1)=31
          Done=1
        Endif
      Endif
    Endif
  Endif
Return
'
Procedure Upchk                   ! what is above you?
  Z=Int(X/16)
  Z2=(X Mod 16)
  S=Z+1+(Y/16)*20-40
  Ok=1
  If S>0
    If Scrn(S)=29 And Key>0
      Put 120+8*Key,8,A$(59)
      Dec Key
      Vsync
      Put Z*16,Y-16,A$(48)
      Scrn(S)=0
      Sound 1,15,#70000
      Sound 2,14,#70000
      Wave 7,7,9,4096
    Endif
  Endif
  If Y=16 And D%((Room-1)*5+1)<>0
    Bye=1
  Endif
  If S>=0
    If (Scrn(S)>=1 And Scrn(S)<=4) Or Scrn(S)=28 Or Scrn(S)=29 Or Scrn(S)>32
      Ok=0
    Endif
    If Z2<>0
      If (Scrn(S+1)=>1 And Scrn(S+1)<=4) Or Scrn(S+1)=28 Or Scrn(S+1)=29 Or Scrn(S+1)>32
        Ok=0
      Endif
    Endif
    If Ok=1
      If Scrn(S)>4 And Scrn(S)<26
        Sound 1,12,#700
        Sound 2,12,#70000
        Wave 15,7,9,2048
        Put Z*16,Y-16,A$(48)
        Obj=Scrn(S)
        Gosub Got_obj
        Scrn(S)=0
      Else
        If Scrn(S)=31
          Done=1
        Endif
      Endif
      If Z2<>0
        If Scrn(S+1)>4 And Scrn(S+1)<26
          Sound 1,12,#700
          Sound 2,12,#70000
          Wave 15,7,9,2048
          Put Z*16+16,Y-16,A$(48)
          Obj=Scrn(S+1)
          Gosub Got_obj
          Scrn(S+1)=0
        Else
          If Scrn(S+1)=31
            Done=1
          Endif
        Endif
      Endif
    Endif
  Else
    Ok=0
  Endif
Return
'
Procedure Monsters                  ! loop for moving the bad guys
  Local Zz%,Ms%,Md%,Mn%,My%,Mx%
  For T%=1 To 4
    Inc Zt%
    If Zt%=10
      Zt%=1
    Endif
    Zz%=Zt%*5
    Mx%=Mon(Zz%-4)
    My%=Mon(Zz%-3)
    Md%=Mon(Zz%-2)
    Ms%=Mon(Zz%-1)
    Mn%=Mon(Zz%)
    If Md%<>0
      Sp=25
      If Ms%=5
        Gosub Ndir
        Sp=0
      Endif
      If Md%>0 And Md%<6
        On Md% Gosub Morig,Molef,Moup,Modwn,Mono
        For S=1 To Sp
        Next S
      Else
        If Md%=8
          Inc Ms%
          If Ms%=6
            Vsync
            Put Mx%,My%,A$(71)
          Else
            If Ms%=7
              Md%=0
              Put Mx%,My%,A$(48)
              Ms%=0
              Add Co,15
            Endif
          Endif
        Endif
      Endif
      If Abs(X-Mx%)<15
        If Abs(Y-My%)<15 And (Clok=<0 Or Cstart=0)
          Sound 1,4,#1500
          Sound 2,4,#21800
          Wave 15,7,0,2048
          Food%=Food%-Lev%-1
        Endif
      Endif
      Mon(Zz%-4)=Mx%
      Mon(Zz%-3)=My%
      Mon(Zz%-2)=Md%
      Mon(Zz%-1)=Ms%
    Else
      For E=1 To 140
      Next E
    Endif
  Next T%
Return
'
Procedure Morig                                          ! move right
  Nom%=Ms%+15-(Mn%=16)*35-(Mn%=32)*60-(Mn%=38)*70-(Mn%=39)*77
  I%=(Mx% Div 16)+(My% Div 16)*20-19
  If Ms%>1 And Mons%(I%+1)=0
    Mons%(I%)=0
  Endif
  If Mons%(I%)=1
    Put Mx%,My%,A$(49)
    Add Mx%,4
    Vsync
    Put Mx%,My%,A$(Nom%)
  Else
    Vsync
    Put Mx%,My%,A$(60)
    Ms%=4
  Endif
  Inc Ms%
  If Ms%=5
    Mons%((Mx% Div 16)+((My% Div 16)-1)*20)=0
  Endif
Return
'
Procedure Molef                                          ! move left
  Nom%=Ms%+15-(Mn%=16)*35-(Mn%=32)*60-(Mn%=38)*70-(Mn%=39)*77
  I%=(Mx% Div 16)+(My% Div 16)*20-19
  If Ms%=2 And Mons%(I%+1)=0
    Mons%(I%)=0
  Endif
  If Mons%(I%)=1
    Put Mx%+12,My%,A$(49)
    Sub Mx%,4
    Vsync
    Put Mx%,My%,A$(Nom%)
  Else
    Vsync
    Put Mx%,My%,A$(60)
    Ms%=4
  Endif
  Inc Ms%
  If Ms%=4
    Mons%(I%+1)=0
  Endif
Return
'
Procedure Mono                                           ! can't move
  If Ms%=0 Or Ms%>4
    Ms%=1
  Endif
  Nom%=Ms%+15-(Mn%=16)*35-(Mn%=32)*60-(Mn%=38)*70-(Mn%=39)*77
  If Mons%((Mx% Div 16)+(My% Div 16)*20-19)=1
    Vsync
    Put Mx%,My%,A$(Nom%)
  Else
    Vsync
    Put Mx%,My%,A$(60)
    Ms%=4
  Endif
  Inc Ms%
Return
'
Procedure Ndir                           ! find new direction for bad guy
  Local At%,L%,R%,Dw%,U%
  At%=(Mx% Div 16)+1+((My% Div 16)-1)*20
  L%=Mons%(At%-1)-(Mx%<16)
  R%=Mons%(At%+1)-(Mx%>300)
  If At%>19
    U%=Mons%(At%-20)-(My%<17)
  Else
    U%=1
  Endif
  Dw%=Mons%(At%+20)-(My%>174)
  If Mons%(At%)=1
    If X>(Mx%+8) And Scrn(At%+1)=0 And R%=0
      Ms%=1
      Md%=1
      Mons%(At%+1)=1
    Else
      If Y>(My%+8) And Scrn(At%+20)=0 And Dw%=0
        Ms%=1
        Md%=4
        Mons%(At%+20)=1
      Else
        If Y<(My%-8) And U%=0 And At%>19
          If Scrn(At%-20)=0
            Ms%=1
            Md%=3
            Mons%(At%-20)=1
          Endif
        Endif
      Endif
    Endif
    If Ms%=5 And X<(Mx%-8) And Scrn(At%-1)=0 And L%=0
      Md%=2
      Ms%=1
      Mons%(At%-1)=1
    Endif
    If Ms%=5
      If Scrn(At%+1)=0 And R%=0
        Md%=1
        Ms%=1
        Mons%(At%+1)=1
      Else
        If Scrn(At%-1)=0 And L%=0
          Md%=2
          Ms%=1
          Mons%(At%-1)=1
        Else
          If Scrn(At%+20)=0 And Dw%=0
            Md%=4
            Ms%=1
            Mons%(At%+20)=1
          Else
            If At%>19
              If Scrn(At%-20)=0 And U%=0
                Md%=3
                Ms%=1
                Mons%(At%-20)=1
              Else
                Md%=5
              Endif
            Else
              Md%=5
            Endif
          Endif
        Endif
      Endif
    Endif
  Else
    Vsync
    If Md%=1
      Mons%(At%+1)=0
    Endif
    If Md%=2
      Mons%(At%+1)=0
    Endif
    If Md%=3
      Mons%(At%+20)=0
    Endif
    If At%>19
      If Md%=4
        Mons%(At%+20)=0
      Endif
    Endif
    Md%=8
    Mons%(At%)=0
  Endif
Return
'
Procedure Modwn                                         ! move down
  Nom%=15+Ms%-(Mn%=16)*35-(Mn%=32)*60-(Mn%=38)*70-(Mn%=39)*77
  I%=((Mx% Div 16)+(My% Div 16)*20-19)
  If Mons%(I%)=1 And Mons%(I%+20)=1
    Put Mx%,My%,A$(50)
    Add My%,4
    Vsync
    Put Mx%,My%,A$(Nom%)
  Else
    Vsync
    Put Mx%,My%,A$(60)
    Ms%=4
  Endif
  Inc Ms%
  If Ms%=5
    Mons%(I%)=0
  Endif
Return
'
Procedure Moup                                           ! move up
  Nom%=15+Ms%-(Mn%=16)*35-(Mn%=32)*60-(Mn%=38)*70-(Mn%=39)*77
  If Mons%((Mx% Div 16)+(My% Div 16)*20-19)=1
    Put Mx%,My%+12,A$(50)
    Sub My%,4
    Vsync
    Put Mx%,My%,A$(Nom%)
  Else
    Vsync
    Put Mx%,My%,A$(60)
    Ms%=4
  Endif
  Inc Ms%
  If Ms%=5
    Mons%((Mx% Div 16)+1+((My% Div 16))*20)=0
  Endif
Return
'
Procedure Fired
  If Fire%=1
    If Kn>0
      If (F(1)=0) Or (F(2)=0 Or F(3)=0) And (Joy%=1 Or Joy%=2 Or Joy%=4 Or Joy%=8)
        If F(1)=0
          S=1
        Else
          If F(2)=0
            S=2
          Else
            S=3
          Endif
        Endif
        On Joy% Gosub Ge3,Ge4,Nt,Ge2,Nt,Nt,Nt,Ge1
        F(S*4)=Mx
        F(S*4+1)=My
        F(S*4+2)=Ms
        F(S*4+3)=-1*(Joy%=1)-2*(Joy%=2)-4*(Joy%=4)-8*(Joy%=8)
        F(S)=Mf
        If F(S)<>0
          Dec Kn
          Put 176,0,A$(14)
          Text 176,5,Kn
          Fid%=2
          Sound 1,2,#4000
          Sound 2,4,#6000
          Wave 15,10,10,400
        Endif
      Endif
    Endif
  Endif
Return
'
Procedure Ge4                           ! fired down (see if ok to throw)
  Is=0
  E=(X Mod 16)/4
  If (E=1) Or (E=3)
    Mx=X+4
  Else
    Mx=X+8
  Endif
  My=Y+24
  E=(My Mod 16)/4
  At=Int(Mx/16)+Int(My/16)*20-19
  If At<200
    If E=0
      Ms=4
      If Scrn(At)=0
        Is=1
      Endif
    Else
      If E=1
        Ms=5
        If Scrn(At)=0 And Scrn(At+20)=0
          Is=1
        Endif
      Else
        If E=2
          Ms=1
          If Scrn(At)=0 And Scrn(At+20)=0
            Is=1
          Endif
        Else
          Ms=2
          If Scrn(At)=0 And Scrn(At+20)=0
            Is=1
          Endif
        Endif
      Endif
    Endif
  Endif
  If At<200
    Mf=Is
  Else
    Mf=0
  Endif
Return
'
Procedure Ge3                         ! fired up (see if ok to throw)
  E%=(Y Mod 16) Div 4
  Ms=(0-(E%=0)*3-(E%=1)*2-(E%=2)*5-(E%=3)*3)
  E%=(X Mod 16) Div 4
  My=Y-8
  If E%=1 Or E%=3
    Mx=X+4
  Else
    Mx=X
  Endif
  E%=(Mx Div 16)+(My Div 16)*20-19
  If (E%-20)>0
    If Scrn(E%)=0 And Scrn(E%-20)=0
      Mf=1
    Else
      Mf=0
    Endif
  Else
    Mf=0
  Endif
Return
'
Procedure Ge2                            ! fired left (see if ok to throw)
  E%=(X Mod 16) Div 4
  Ms=(0-(E%=0)*2-(E%=1)*4-(E%=2)*1-(E%=3)*3)
  Mx=X-8
  E%=(Y Mod 16) Div 4
  If E%=1 Or E%=3
    My=Y+4
  Else
    My=Y
  Endif
  I%=(Mx Div 16)+(My Div 16)*20-19
  If I%>1
    If Scrn(I%)=0 And Scrn(I%-1)=0 And Mx>8
      Mf=1
    Else
      Mf=0
    Endif
  Endif
Return
'
Procedure Ge1                           ! fired right (see if ok to throw)
  E%=(X Mod 16) Div 4
  Ms=(0-(E%=0)*3-(E%=1)*4-(E%=2)*1-(E%=3)*2)
  Mx=X+24
  E%=(Y Mod 16) Div 4
  If E%=1 Or E%=3
    My=Y+4
  Else
    My=Y
  Endif
  E%=Int(Mx/16)+(Int(My/16))*20-19
  If E%>0
    If Scrn(E%+1)=0 And Scrn(E%)=0 And Mx<297
      Mf=1
    Else
      Mf=0
    Endif
  Endif
Return
'
Procedure Sho                   ! loop for moving knives
  Local S%,Ms%,Mx%,My%,E%
  For S%=1 To 4
    Inc Shoo%
    If Shoo%=4
      Shoo%=1
    Endif
    Ms%=F(Shoo%*4+2)
    Mx%=F(Shoo%*4)
    My%=F(Shoo%*4+1)
    If F(Shoo%)=0
      For T=1 To 100
      Next T
    Else
      If Ms%=0 Or Ms%=5
        Gosub Hit
        Ms%=F(Shoo%*4+2)
      Endif
      If F(Shoo%)<>0
        E%=Shoo%*4+3
        If F(E%)=8
          Gosub Shotr
          F(Shoo%)=Fm
        Else
          If F(E%)=4
            Gosub Shotl
            F(Shoo%)=Fm
          Else
            If F(E%)=1
              Gosub Shotu
              F(Shoo%)=Fm
            Else
              If F(E%)=2
                Gosub Shotd
                F(Shoo%)=Fm
              Endif
            Endif
          Endif
        Endif
      Else
        Sound 2,0,#0
        Wave 1,1,1,256
      Endif
    Endif
    F(Shoo%*4+2)=Ms%
    F(Shoo%*4)=Mx%
    F(Shoo%*4+1)=My%
  Next S%
Return
'
Procedure Hit                  ! did knife hit anything?
  Local D%,At%
  D%=F(Shoo%*4+3)
  At%=(Mx% Div 16)+(My% Div 16)*20-19
  If At%>0
    If D%=8
      If Scrn(At%+1)<>0
        Sound 1,10,#300
        If Scrn(At%+1)=4
          Sound 1,12,#300
          Vsync
          Put (Mx% Div 16)*16+16,(My% Div 16)*16,A$(61)
          Scrn(At%+1)=28
        Else
          If Scrn(At%+1)=28
            Sound 1,12,#70000
            Vsync
            Put (Mx% Div 16)*16+16,(My% Div 16)*16,A$(48)
            Scrn(At%+1)=0
          Endif
        Endif
        Put Mx%,My%,A$(59)
        F(Shoo%)=0
      Else
        If Mx%>300
          F(Shoo%)=0
          Put Mx%,My%,A$(59)
        Else
          F(Shoo%*4+2)=1
        Endif
      Endif
    Else
      If D%=4
        If Scrn(At%-1)<>0
          Sound 1,10,#300
          If Scrn(At%-1)=4
            Sound 1,12,#300
            Vsync
            Put (Mx% Div 16)*16-16,(My% Div 16)*16,A$(61)
            Scrn(At%-1)=28
          Else
            If Scrn(At%-1)=28
              Sound 1,12,#70000
              Vsync
              Put (Mx% Div 16)*16-16,(My% Div 16)*16,A$(48)
              Scrn(At%-1)=0
            Endif
          Endif
          Put Mx%,My%,A$(59)
          F(Shoo%)=0
        Else
          If Mx%<16
            F(Shoo%)=0
            Put Mx%,My%,A$(59)
          Else
            F(Shoo%*4+2)=1
          Endif
        Endif
      Else
        If D%=1
          If At%<20
            F(Shoo%)=0
            Put Mx%,My%,A$(59)
          Else
            If Scrn(At%-20)<>0
              Sound 1,10,#300
              F(Shoo%)=0
              If Scrn(At%-20)=4
                Sound 1,12,#500
                Vsync
                Put (Mx% Div 16)*16,(My% Div 16)*16-16,A$(61)
                Scrn(At%-20)=28
              Else
                If Scrn(At%-20)=28
                  Sound 1,12,#70000
                  Vsync
                  Put (Mx% Div 16)*16,(My% Div 16)*16-16,A$(48)
                  Scrn(At%-20)=0
                Endif
              Endif
              Put Mx%,My%,A$(59)
            Else
              F(Shoo%*4+2)=1
            Endif
          Endif
        Else
          If D%=2
            If My%>164
              F(Shoo%)=0
              Put Mx%,My%,A$(59)
            Else
              If Scrn(At%+20)<>0
                Sound 1,10,#300
                F(Shoo%)=0
                If Scrn(At%+20)=4
                  Sound 1,12,#400
                  Vsync
                  Put (Mx% Div 16)*16,(My% Div 16)*16+16,A$(61)
                  Scrn(At%+20)=28
                Else
                  If Scrn(At%+20)=28
                    Sound 1,12,#70000
                    Vsync
                    Put (Mx% Div 16)*16,(My% Div 16)*16+16,A$(48)
                    Scrn(At%+20)=0
                  Endif
                Endif
                Put Mx%,My%,A$(59)
              Else
                F(Shoo%*4+2)=1
              Endif
            Endif
          Endif
        Endif
      Endif
    Endif
  Else
    F(Shoo%)=0
    Put Mx%,My%,A$(59)
  Endif
Return
'
Procedure Shotr                 ! throwing knife right
  If Ms%=>5
    Ms%=1
  Endif
  Nom%=54+Ms%
  Put Mx%,F(Shoo%*4+1),A$(59)
  Inc Ms%
  Add Mx%,4
  I%=(Mx% Div 16)+(My% Div 16)*20-19
  If Mons%(I%)=0
    Put Mx%,F(Shoo%*4+1),A$(Nom%)
    Fm=1
  Else
    Mons%(I%)=0
    Sound 1,10,#1500
    Sound 2,10,#1800
    Wave 15,7,9,6000
    Fm=0
  Endif
Return
'
Procedure Shotl                  ! throwing knife left
  If Ms%=>5
    Ms%=1
  Endif
  Nom%=54+Ms%
  Put Mx%,F(Shoo%*4+1),A$(59)
  Inc Ms%
  Sub Mx%,4
  I%=(Mx% Div 16)+(My% Div 16)*20-19
  If Mons%(I%)=0
    Put Mx%,F(Shoo%*4+1),A$(Nom%)
    Fm=1
  Else
    Mons%(I%)=0
    Sound 1,10,#1500
    Sound 2,10,#1800
    Wave 15,7,9,6000
    Fm=0
  Endif
Return
'
Procedure Shotu                  ! throwing knife up
  Nom%=54+Ms%
  Put Mx%,My%,A$(59)
  Inc Ms%
  Sub My%,4
  I%=(Mx% Div 16)+(My% Div 16)*20-19
  If Mons%(I%)=0
    Put Mx%,My%,A$(Nom%)
    Fm=1
  Else
    Mons%(I%)=0
    Sound 1,10,#1500
    Sound 2,10,#1800
    Wave 15,7,9,6000
    Fm=0
  Endif
Return
'
Procedure Shotd                  ! throwing knife down
  Nom%=54+Ms%
  Put Mx%,My%,A$(59)
  Inc Ms%
  Add My%,4
  I%=(Mx% Div 16)+(My% Div 16)*20-19
  If Mons%(I%)=0
    Put Mx%,My%,A$(Nom%)
    Fm=1
  Else
    Mons%(I%)=0
    Sound 1,10,#1500
    Sound 2,10,#1800
    Wave 15,7,9,6000
    Fm=0
  Endif
Return
'
Procedure Times                 ! update power
  Put 45,0,A$(14)
  Text 48,5,Food%
Return
'
Procedure Got_obj               ! you grabed an item on the screen
  If Obj=19
    R%=Int(Rnd(0)*3)
    If R%>1
      Obj=11
    Else
      Obj=9
    Endif
  Endif
  If Obj=9
    R%=Int(Rnd(0)*150)+50
    If (Food%+R%)<999
      Add Food%,R%
    Else
      Food%=999
    Endif
  Else
    If Obj=7 Or Obj=10
      If Food%+50<999
        Add Food%,50
      Else
        Food%=999
      Endif
    Else
      If Obj=18
        If Food%+75<999
          Add Food%,75
        Else
          Food%=999
        Endif
      Else
        If Obj=8 Or Obj=14
          If Food%+100<999
            Add Food%,100
          Else
            Food%=999
          Endif
        Else
          If Obj=15
            Inc Key
            Put Key*8+120,8,A$(66)
          Else
            If Obj=20
              If Food%+200<999
                Add Food%,200
              Else
                Food%=999
              Endif
            Else
              If Obj=17
                Inc Diam
                Put 10+Diam*8,8,A$(67)
              Else
                If Obj=6 Or Obj=13
                  Add Kn,25
                  Put 176,0,A$(14)
                  Text 176,5,Kn
                Else
                  If Obj=11
                    Add Kn,10
                    Put 176,0,A$(14)
                    Text 176,5,Kn
                  Else
                    If Obj=5
                      Add Cash,Int(Rnd(0)*200)
                    Else
                      If Obj=16
                        Add Clok,100
                        If Clok>250
                          Clok=250
                        Endif
                        Color 3
                        Line 14,196,Clok+10,196
                        Line 14,197,Clok+10,197
                      Else
                        If Obj=25
                          Add Kn,50
                          Put 176,0,A$(14)
                          Text 176,5,Kn
                        Else
                          If Obj=21 Or Obj=23 Or Obj=24
                            Add Co,100
                          Else
                            If Obj=22
                              Food%=999
                              For E=1 To 2
                                For I=70000 To 70020
                                  Sound 2,12,#I
                                Next I
                              Next E
                              Wave 7,7,9,4096
                            Else
                              If Obj=12
                                For T=1 To 10
                                  For Z=70000 To 70100
                                    Sound 1,14-(T/2),#Z
                                  Next Z
                                Next T
                                Add Co,5
                                Sound 1,0,#0
                                Sound 2,0,#0
                                Cls
                                Gosub Gameover
                              Endif
                            Endif
                          Endif
                        Endif
                      Endif
                    Endif
                  Endif
                Endif
              Endif
            Endif
          Endif
        Endif
      Endif
    Endif
  Endif
Return
'
Procedure Died                         ! you died
  Sound 1,0,#0
  Sound 2,0,#0
  For T%=1 To 15
    F(T%)=0
  Next T%
  For T%=1 To 240
    Mons%(T%)=0
    Scrn(T%)=0
  Next T%
  For T%=1 To 50
    Mon(T%)=0
    D%(T%*5)=0
  Next T%
  If Lev%=1
    Bye=6
  Else
    If Lev%=2
      Bye=5
    Else
      If Lev%>2
        Bye=Lev%+4
      Endif
    Endif
  Endif
  Gosub Nex_room
  Bye=0
Return
'
Procedure Get_level                             ! load dungeons from disk
  For T%=1 To 40
    For S%=1 To 11
      Input #1,Z$
      Brd$(S%+(T%-1)*11)=Z$
    Next S%
    Input #1;Z$
    For S%=1 To 4
      A%=Asc(Mid$(Z$,S%,1))-64
      D%(S%+(T%-1)*5)=A%
    Next S%
    D%(5+(T%-1)*5)=0
  Next T%
Return
'
Procedure Nex_room               ! you moved into another room, update screen
  For T%=1 To 3
    F(T%)=0
  Next T%
  If Bye>0 And Bye<5
    For T%=1 To 220
      Screens%((Room-1)*220+T%)=Scrn(T%)
      Mns%((Room-1)*220+T%)=Mons%(T%)
    Next T%
    For T%=1 To 50
      Mondir%(T%+(Room-1)*50)=Mon(T%)
    Next T%
    Room=D%(Bye+(Room-1)*5)
  Else
    If Bye=5
      Lev%=2
      Room=5
    Else
      If Bye=6
        Lev%=1
        Room=1
      Else
        If Bye=7
          Lev%=3
          Room=13
        Else
          If Bye=8
            Lev%=4
            Room=25
          Else
            If Bye=9 Or Bye=11 Or Bye=13
              Lev%=Bye-4
              Room=1
            Else
              If Bye=14
                Room=23
                Lev%=Bye-4
              Else
                If Bye=10 Or Bye=12
                  Lev%=Bye-4
                  Room=21
                Else
                  If Bye>14 And Bye<19
                    Lev%=Bye-4
                    Room=1
                  Endif
                Endif
              Endif
            Endif
          Endif
        Endif
      Endif
    Endif
  Endif
  Sound 1,0,#0
  Sound 2,0,#0
  If D%(5+(Room-1)*5)=0
    For T%=1 To 50
      Mon(T%)=0
    Next T%
    For T%=1 To 240
      Mons%(T%)=0
    Next T%
    Gosub Setscrn
  Else
    For T%=1 To 220
      Scrn(T%)=Screens%((Room-1)*220+T%)
      Mons%(T%)=Mns%((Room-1)*220+T%)
    Next T%
    For T%=1 To 50
      Mon(T%)=Mondir%(T%+(Room-1)*50)
    Next T%
    For T=1 To 11
      For S=0 To 19
        It=Scrn(S+1+(T-1)*20)+1
        Gosub Show
      Next S
    Next T
  Endif
  For W%=1 To 4
    If D%(W%+(Room-1)*5)<>0
      Put 260+W%*8,8,A$(76-W%)
    Else
      Put 260+W%*8,8,A$(59)
    Endif
  Next W%
  If Bye=1
    Y=176
  Else
    If Bye=2
      Y=16
    Else
      If Bye=3
        X=0
      Else
        If Bye=4
          X=304
        Else
          Text 250,5,"LEVEL"
          Text 295,5,Lev%
        Endif
      Endif
    Endif
  Endif
  Bye=Room
Return
'
Procedure Get_done                    ! you are at the EXIT of a level
  If Lev%=1
    Bye=5
  Else
    If Lev%>1 And Lev%<14
      Bye=Lev%+5
    Endif
  Endif
Return
'
Procedure Buy                    ! break point, able to buy power and knives
  Cls
  For T%=9 To 13
    For S%=1 To 11
      Put T%*16,S%*16,A$(48)
    Next S%
  Next T%
  Put 168,16*8,A$(64)
  Put 168,32,A$(63)
  Put 9*16+7,88,A$(92)
  Deftext 13,0,0,6
  Text 1,19,"PLAYER STATUS"
  Deftext 11,0,0,4
  Text 13,32,"KNIVES : "
  Text 64,32,Kn
  Text 13,42,"POWER : "
  Text 60,42,Food%
  Text 13,52,"GOLD : "
  Text 54,52,Cash
  Text 13,62,"SCORE : "
  Text 60,62,Int(Co)
  Xc=16*15+8
  Deftext 5,0,0,6
  Text Xc,26," WIZARD "
  Deftext 7,0,0,4
  Text Xc,40,"OFFERS YOU"
  Text Xc,48,"POWER FOR"
  Text Xc,56,"ONLY TWO"
  Text Xc,64,"GOLD COINS"
  Text Xc,72,"EACH!"
  Text Xc,84,"PRESS <P>"
  Deftext 9,0,0,6
  Text Xc-8,125,"STOREROOM"
  Deftext 8,0,0,4
  Text Xc,136,"KNIVES CAN"
  Text Xc,144,"BE BOUGHT"
  Text Xc,152,"FOR FIVE"
  Text Xc,160,"GOLD COINS"
  Text Xc,168,"EACH."
  Text Xc,182,"PRESS <K>"
  For T=1 To 99
    W$=Inkey$
  Next T
  Deftext 11,0,0,4
  Text 1,160,"ENTER CHOICE"
  Deftext 2,0,0,4
  Text 8,186,"<D> IF DONE"
  While (W$<>"D" And W$<>"d")
    W$=Inkey$
    If W$="k" Or W$="K"
      Deftext 10,0,0,4
      Text 1,100,"BUYING KNIVES - "
      Text 1,110,"PRESS ANY KEY TO STOP."
      For T=1 To 10
        W$=Inkey$
      Next T
      Lp=0
      While W$=""
        W$=Inkey$
        If Cash=>5 And Kn<499
          Sound 1,6,#70000
          Cash=Cash-5
          Kn=Kn+1
          Deftext 11,0,0,4
          Text 54,52,"    "
          Text 54,52,Cash
          Text 64,32,"    "
          Text 64,32,Kn
          For T=1 To (500-Lp)
            Sound 1,13-(T/55),#70000
          Next T
          Lp=Lp+5
          If Lp>350
            Lp=350
          Endif
          Sound 1,0,0,0,0
        Else
          W$="w"
          Text 1,100,"              "
          Text 1,110,"                      "
        Endif
        If W$<>"w"
          W$=Inkey$
        Endif
      Wend
      Text 1,100,"               "
      Text 1,110,"                      "
      For T=1 To 10
        W$=Inkey$
      Next T
    Else
      If W$="p" Or W$="P"
        Deftext 10,0,0,4
        For T=1 To 10
          W$=Inkey$
        Next T
        Text 1,100,"BUYING POWER -"
        Text 1,110,"PRESS ANY KEY TO STOP."
        Lp=0
        While W$=""
          If Cash>1 And Food%<999
            Sub Cash,2
            Inc Food%
            Deftext 11,0,0,4
            Text 54,52,"    "
            Text 54,52,Cash
            Text 58,42,"    "
            Text 60,42,Food%
            For T=1 To (500-Lp)
              Sound 1,13-(T/55),#70000
            Next T
            Sound 1,0,0,0,0
            Add Lp,10
            If Lp>350
              Lp=350
            Endif
          Else
            W$="w"
          Endif
          If W$<>"w"
            W$=Inkey$
          Endif
        Wend
        Text 1,100,"               "
        Text 1,110,"                      "
      Endif
    Endif
  Wend
  Deftext 11,0,0,4
  Text 1,160,"LOADING NEXT STAGE"
  Deftext 10,16,0,4
Return
'
Procedure O_s                    ! title screen
  Cls
  For T=0 To 12
    For S=0 To 19
      Put S*16,T*16,A$(48)
    Next S
  Next T
  If Sw=1
    Sw=0
    For T=1 To 13
      Swap A$(T),A$(100+T)
    Next T
    Swap A$(27),A$(100)
    Swap A$(116),A$(65)
  Endif
  Put 96,8,A$(92)
  Put 48,3,A$(1)
  Put 208,3,A$(101)
  Put 74,32,A$(17)
  Put 106,32,A$(52)
  Put 138,32,A$(77)
  Put 170,32,A$(86)
  Put 202,32,A$(93)
  Put 48,64,A$(22)
  Put 80,64,A$(25)
  Put 112,64,A$(33)
  Put 144,64,A$(29)
  Put 176,64,A$(23)
  Put 208,64,A$(35)
  Put 240,64,A$(24)
  Put 272,63,A$(34)
  Put 52,104,A$(26)
  Put 84,104,A$(28)
  Put 116,104,A$(21)
  Put 148,104,A$(40)
  Put 180,104,A$(34)
  Put 48,146,A$(38)
  Put 80,146,A$(32)
  Put 112,146,A$(37)
  Put 144,146,A$(30)
  Put 176,146,A$(31)
  Put 208,146,A$(36)
  Put 240,146,A$(20)
  Put 272,146,A$(39)
  Put 61,179,A$(43)
  Put 87,179,A$(41)
  Put 113,179,A$(91)
  Put 139,179,A$(44)
  Put 165,179,A$(90)
  Put 191,179,A$(70)
  Put 217,179,A$(97)
  Put 243,179,A$(98)
  Put 269,179,A$(80)
  Graphmode 2
  Deftext 15,0,0,4
  Text 54,126,"10"
  Text 86,126,"25"
  Text 118,126,"25"
  Text 150,126,"50"
  Text 185,126,"?"
  Text 50,85,"50"
  Text 82,85,"50"
  Text 114,85,"75"
  Text 143,85,"100"
  Text 175,85,"100"
  Text 207,85,"200"
  Text 245,85,"?"
  Text 278,85,"?"
  Deftext 0,0,0,4
  Text 12,20,"HERO"
  Text 6,13,"PRINCE"
  Text 236,13," PRINCESS "
  Text 6,42,"ENEMIES"
  Text 6,74,"POWER"
  Text 6,113,"WEAPONS"
  Text 6,155,"OTHER"
  Text 6,187,"BARRIERS"
  Deftext 9,0,0,4
  Text 5,12,"PRINCE"
  Deftext 4,0,0,4
  Text 235,12," PRINCESS "
  Deftext 1,0,0,4
  Text 5,42,"ENEMIES"
  Deftext 5,0,0,4
  Text 5,73,"POWER"
  Deftext 13,0,0,4
  Text 5,112,"WEAPONS"
  Deftext 11,0,0,4
  Text 5,154,"OTHER"
  Deftext 6,0,0,4
  Text 5,186,"BARRIERS"
  If Co>0
    Deftext 15,0,0,4
    Text 96,24,"SCORE "
    Text 130,24,Int(Co)
  Endif
  Deftext 0,0,2700,4
  Text 311,6,190,"  1990  ANTIC PUBLISHING"
  S$=Chr$(189)+" 1990  ANTIC PUBLISHING"
  Deftext 15,0,2700,4
  Text 311,5,190,S$
  Graphmode 1
  For T=1 To 99
    A$=Inkey$
  Next T
  While A$=""
    For T=1 To 4
      Vsync
      Put 74,32,A$(T+15)
      Put 106,32,A$(50+T)
      Put 138,32,A$(T+75)
      Put 170,32,A$(T+85)
      Put 202,32,A$(T+92)
      Pause 5
    Next T
    A$=Inkey$
    Gosub Jj
    If Fire%=1
      A$=" "
      Joy%=0
    Endif
    If Joy%<>0
      A$="~"
    Endif
    If A$="~"
      For T=1 To 13
        Swap A$(T),A$(100+T)
      Next T
      Swap A$(27),A$(100)
      Swap A$(116),A$(65)
      Graphmode 2
      Deftext 2,0,0,4
      If Sw=1
        C$="HEROINE"
      Else
        C$="HERO"
      Endif
      Text 0-(Sw=0)*12-(Sw=1)*244,20,C$
      Sw=1+(Sw=1)
      If Sw=1
        C$="HEROINE"
      Else
        C$="HERO"
      Endif
      Deftext (0-(Sw=1)*4),0,0,4
      Text 0-(Sw=0)*12-(Sw=1)*244,20,C$
      If Sw=1
      Endif
      A$=""
      Graphmode 1
    Endif
  Wend
  If A$=Chr$(27)
    @Exit
  Endif
  For T=1 To 99
    A$=Inkey$
  Next T
Return
'
Procedure Get_chars              ! pressed a key during play
  B$=Upper$(B$)
  If B$="C" And Cstart=0
    Cstart=1
  Else
    If B$="C" And Cstart=1
      Cstart=0
    Else
      If B$=" "
        For T=1 To 99
          A$=Inkey$
        Next T
        While Inkey$=""
        Wend
      Else
        If Asc(B$)=27
          Men%=0
          Die=1
        Endif
      Endif
    Endif
  Endif
  For T=1 To 50
    B$=Inkey$
  Next T
Return
'
Procedure Gameover
  Deftext 11,0,0,6
  Text 80,8,"MYSTIC REALM"
  Deftext 11,0,0,4
  Text 99,18,"THE RESCUE"
  Deftext 10,0,0,4
  Text 52,35,"YOU HAVE SUCCESSFULLY COMPLETED"
  Text 52,45,"THE RESCUE MISSION!"
  Text 52,55,"YOUR SCORE WAS : "
  Text 160,55,Int(Co)
  Text 52,70,"BUT YOUR WORRIES ARE FAR FROM OVER!"
  Text 52,80,"YOU STILL HAVE TO ESCAPE FROM THE"
  Text 52,90,"MYSTIC REALM!"
  Deftext 11,0,0,6
  Text 80,155,"MYSTIC REALM"
  Deftext 11,0,0,4
  Text 98,165,"THE ESCAPE"
  Deftext 10,0,0,4
  While Flash=0
    Text 95,180,"COMING SOON"
    Pause 10
    Text 95,180,"           "
    Pause 10
  Wend
Return
'
Procedure Init                              ! initialize joystick
  Mc$=Mki$(9160)+Mkl$(*B%)+Mki$(20085)
  V%=Xbios(34)+24
  O%=Lpeek(V%)
  Lpoke V%,Varptr(Mc$)
  B%=0
  Out 4,22
  Repeat
  Until B%
  Lpoke V%,O%
  Js%=B%+2
  Out 4,20
Return
Procedure Exit
  '
  If Res%=1
    A%=Xbios(3)
    B%=Xbios(2)
    C%=Xbios(5,L:A%,L:B%,1)
  Endif
  @Restore_pal
  Out 4,8
  End
  '
Return
' ------------- SAVE ORIGINAL COLOR PALETTE -----------------------
Procedure Save_pal
  '
  Dim Spalette%(16,3)
  '
  For Z%=0 To 15
    Dpoke Contrl,26
    Dpoke Contrl+2,0
    Dpoke Contrl+6,2
    Dpoke Intin,Z%
    Dpoke Intin+2,0
    Vdisys
    Spalette%(Z%,0)=Dpeek(Intout+2)
    Spalette%(Z%,1)=Dpeek(Intout+4)
    Spalette%(Z%,2)=Dpeek(Intout+6)
  Next Z%
Return
'
Procedure Restore_pal
  ' --------------------- RESTORES PALLET -------------------
  '
  For Z%=0 To 15
    Dpoke Contrl,14
    Dpoke Contrl+2,0
    Dpoke Contrl+6,4
    Dpoke Intin,Z%
    Dpoke Intin+2,Spalette%(Z%,0)
    Dpoke Intin+4,Spalette%(Z%,1)
    Dpoke Intin+6,Spalette%(Z%,2)
    Vdisys
  Next Z%
Return
'
